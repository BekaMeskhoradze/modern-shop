{% load static %}
<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="light dark" />
    <link rel="icon" href="{% static 'favicon.ico' %}">
    <title>
      {% block title %}Modern Shop{% endblock %}
    </title>
    <!-- Tailwind (config + CDN) -->
    <script>
      window.tailwind = window.tailwind || {};
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            fontFamily: { sans: ["Inter","ui-sans-serif","system-ui"], display: ["Inter","ui-sans-serif","system-ui"] },
            boxShadow: { soft: "0 10px 30px rgba(0,0,0,.08)" },
          },
        },
      };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
    <!-- Google Font -->
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
          rel="stylesheet" />
    <!-- THEME VARIABLES + LIGHTWEIGHT TRANSITIONS -->
    <style>
      :root {
        --page-bg:#f7f7f8; --surface:#fff; --card:#fff; --line:rgba(2,6,23,.1);
        --text-1:#0f172a; --text-2:#6b7280; --brand:#0f172a; --accent:#f59e0b;
      }
      .dark {
        --page-bg:#0b1220; --surface:#0f172a; --card:#111827; --line:rgba(255,255,255,.12);
        --text-1:#e5e7eb; --text-2:#94a3b8; --brand:#0f172a; --accent:#f59e0b;
      }
      html,body{height:100%}
      body{background:var(--page-bg);color:var(--text-1);font-family:Inter,ui-sans-serif,system-ui;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
      .surface{background:var(--surface);border-color:var(--line)}
      .card{background:var(--card);border-color:var(--line)}
      .muted{color:var(--text-2)} .brand-btn{background:var(--brand);color:#fff} .accent{color:var(--accent)}
      .theme-smooth *, .theme-smooth *::before, .theme-smooth *::after{transition:none}
      .theme-smooth :where(header,footer,nav,main,.surface,.card,.brand-btn,button,a,input,select,textarea,.chip,.badge){
        transition:background-color .28s ease,color .28s ease,border-color .28s ease,box-shadow .28s ease;
      }
      .pattern-layer{position:fixed;inset:0;pointer-events:none;background-size:18px 18px;transition:opacity .28s ease;will-change:opacity}
      .pattern-light{background-image:radial-gradient(circle at 1px 1px, rgba(0,0,0,.05) 1px, transparent 0);opacity:1}
      .pattern-dark{background-image:radial-gradient(circle at 1px 1px, rgba(255,255,255,.06) 1px, transparent 0);opacity:0}
      .dark .pattern-light{opacity:0} .dark .pattern-dark{opacity:1}
    </style>
    <!-- Initial theme + HTMX CSRF -->
    <script>
      (function(){
        const ls = localStorage.getItem("theme");
        const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
        if (ls==="dark" || (!ls && prefersDark)) document.documentElement.classList.add("dark");
      })();

      // focus search after swaps
      document.addEventListener("htmx:afterSwap", () => {
        const input = document.querySelector('input[name="q"]'); if (input) input.focus();
      });

      // CSRF header for HTMX
      function getCookie(name){
        const value=`; ${document.cookie}`; const parts=value.split(`; ${name}=`); if(parts.length===2) return parts.pop().split(";").shift();
      }
      document.addEventListener("htmx:configRequest", (e) => {
        const token=getCookie("csrftoken"); if (token) e.detail.headers["X-CSRFToken"]=token;
      });
    </script>
  </head>
  <body class="min-h-screen antialiased"
        hx-boost="true"
        hx-target="#content"
        hx-select="#content"
        hx-push-url="true">
    <!-- BG + pattern -->
    <div class="fixed inset-0 -z-10" style="background-color: var(--page-bg)"></div>
    <div class="pattern-layer pattern-light -z-10"></div>
    <div class="pattern-layer pattern-dark -z-10"></div>
    <!-- Header -->
    <header class="sticky top-0 z-50 surface border-b">
      <div class="max-w-7xl mx-auto px-4">
        <div class="h-16 flex items-center justify-between gap-3">
          <!-- Brand -->
          <a href="{% url 'core:index' %}" class="inline-flex items-center gap-2">
            <div class="w-9 h-9 rounded-full brand-btn grid place-items-center shadow-soft">
              <svg xmlns="http://www.w3.org/2000/svg"
                   class="w-4 h-4"
                   viewBox="0 0 24 24"
                   fill="currentColor">
                <path d="M12 3l8 5v8l-8 5-8-5V8l8-5zM8 10.2v3.6L12 16l4-2.2v-3.6L12 8l-4 2.2z" />
              </svg>
            </div>
            <span class="font-semibold text-xl tracking-tight">Modern <span class="accent">Shop</span></span>
          </a>
          <!-- Search (desktop) -->
          <form action="{% url 'core:search' %}"
                method="get"
                class="hidden md:flex items-center gap-2 flex-1 max-w-2xl mx-4">
            <div class="relative w-full">
              <span class="pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 opacity-60">
                <svg xmlns="http://www.w3.org/2000/svg"
                     class="w-5 h-5"
                     viewBox="0 0 24 24"
                     fill="currentColor">
                  <path d="M15.5 14h-.79l-.28-.27A6.5 6.5 0 1016 9.5c0 1.61-.59 3.09-1.57 4.23l.27.27h.79L20 18.5 18.5 20l-3-3zM5 9.5C5 7.01 7.01 5 9.5 5S14 7.01 14 9.5 11.99 14 9.5 14 5 11.99 5 9.5z" />
                </svg>
              </span>
              <input type="text"
                     name="q"
                     value="{{ search_query|default:'' }}"
                     placeholder="Search clothing, shoes, accessories…"
                     class="w-full pl-10 pr-3 py-2.5 rounded-xl border card focus:outline-none focus:ring-2"
                     style="--tw-ring-color: rgba(245, 158, 11, 0.25)" />
            </div>
            <button type="submit"
                    class="px-4 py-2.5 rounded-xl brand-btn hover:opacity-90 transition">Search</button>
          </form>
          <!-- Actions -->
          <div class="flex items-center gap-2">
            {% if request.user.is_authenticated %}
              <!-- Account dropdown -->
              <div class="relative">
                <button id="accountMenuBtn"
                        type="button"
                        class="inline-flex items-center gap-2 px-3 py-2 rounded-xl border card hover:shadow-soft transition"
                        aria-haspopup="menu"
                        aria-expanded="false">
                  <svg xmlns="http://www.w3.org/2000/svg"
                       class="w-5 h-5 opacity-80"
                       viewBox="0 0 24 24"
                       fill="currentColor">
                    <path d="M12 12a5 5 0 100-10 5 5 0 000 10zm0 2c-4.2 0-8 2.1-8 5v1h16v-1c0-2.9-3.8-5-8-5z" />
                  </svg>
                  <span class="truncate max-w-[120px]">{{ request.user.first_name|default:"Account" }}</span>
                  <svg xmlns="http://www.w3.org/2000/svg"
                       class="w-4 h-4 opacity-70"
                       viewBox="0 0 24 24"
                       fill="currentColor">
                    <path d="M7 10l5 5 5-5z" />
                  </svg>
                </button>
                <!-- Dropdown -->
                <div id="accountMenu"
                     class="hidden absolute right-0 mt-2 w-56 rounded-xl border card shadow-soft z-[60] overflow-hidden">
                  <a href="{% url 'users:profile' %}"
                     class="flex items-center gap-2 px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-800">
                    <svg xmlns="http://www.w3.org/2000/svg"
                         class="w-4 h-4 opacity-80"
                         viewBox="0 0 24 24"
                         fill="currentColor">
                      <path d="M12 12a5 5 0 100-10 5 5 0 000 10zm0 2c-4.2 0-8 2.1-8 5v1h16v-1c0-2.9-3.8-5-8-5z" />
                    </svg>
                    <span>Profile</span>
                  </a>
                  <div class="border-t" style="border-color: var(--line)"></div>
                  <form method="post" action="{% url 'users:logout' %}">
                    {% csrf_token %}
                    <button type="submit"
                            class="w-full text-left flex items-center gap-2 px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-800 text-red-600">
                      <svg xmlns="http://www.w3.org/2000/svg"
                           class="w-4 h-4 opacity-80"
                           viewBox="0 0 24 24"
                           fill="currentColor">
                        <path d="M10 17l5-5-5-5v10zm-4 4h8v-2H6V5h8V3H6a2 2 0 00-2 2v14a2 2 0 002 2z" />
                      </svg>
                      <span>Sign out</span>
                    </button>
                  </form>
                </div>
              </div>
            {% else %}
              <a href="{% url 'users:login' %}"
                 class="hidden sm:inline-flex items-center gap-2 px-3 py-2 rounded-xl border card hover:shadow-soft transition">
                <svg xmlns="http://www.w3.org/2000/svg"
                     class="w-5 h-5 opacity-80"
                     viewBox="0 0 24 24"
                     fill="currentColor">
                  <path d="M12 12a5 5 0 100-10 5 5 0 000 10zm0 2c-4.2 0-8 2.1-8 5v1હ16v-1c0-2.9-3.8-5-8-5z" />
                </svg>
                <span>Sign in</span>
              </a>
            {% endif %}
            {% include "cart/includes/cart_button.html" %}
            <!-- Theme toggle -->
            <button id="themeToggle"
                    type="button"
                    class="inline-flex items-center justify-center w-10 h-10 rounded-xl border card hover:shadow-soft transition"
                    aria-label="Toggle theme">
              <svg id="sun"
                   class="w-5 h-5 block dark:hidden"
                   viewBox="0 0 24 24"
                   fill="currentColor">
                <path d="M6.76 4.84l-1.8-1.79-1.41 1.41 1.79 1.8 1.42-1.42zM1 13h3v-2H1v2zm10-9h2V1h-2v3zm7.04 2.46l1.79-1.8-1.41-1.41-1.8 1.79 1.42 1.42zM20 13h3v-2h-3v2zm-8 8h2v-3h-2વ3zM4.96 18.54l-1.79 1.8 1.41 1.41 1.8-1.79-1.42-1.42zM17.24 19.16l1.8 1.79 1.41-1.41-1.79-1.8-1.42 1.42zM12 6a6 6 0 100 12A6 6 0 0012 6z" />
              </svg>
              <svg id="moon"
                   class="w-5 h-5 hidden dark:block"
                   viewBox="0 0 24 24"
                   fill="currentColor">
                <path d="M12.22 2a10 10 0 109.78 11.01A8 8 0 0112.22 2z" />
              </svg>
            </button>
            <!-- Mobile search -->
            <a href="{% url 'core:search' %}"
               class="md:hidden inline-flex items-center justify-center w-10 h-10 rounded-xl border card"
               aria-label="Search">🔎</a>
          </div>
        </div>
      </div>
      <!-- Categories nav -->
      <nav class="border-t" style="border-color: var(--line)">
        <div class="max-w-7xl mx-auto px-4 py-3 flex gap-2 overflow-x-auto">
          <a href="{% url 'core:catalog_all' %}"
             class="px-3 py-1.5 rounded-full text-sm whitespace-nowrap transition border"
             style="background:{% if not current_category %}var(--brand){% else %}var(--card){% endif %};
                    color:{% if not current_category %}#fff{% else %}var(--text-1){% endif %};
                    border-color:var(--line)">All</a>
          {% for category in categories %}
            <a href="{% url 'core:catalog_category' category.slug %}"
               class="px-3 py-1.5 rounded-full text-sm whitespace-nowrap transition border"
               style="background:{% if current_category == category.slug %}var(--brand){% else %}var(--card){% endif %};
                      color:{% if current_category == category.slug %}#fff{% else %}var(--text-1){% endif %};
                      border-color:var(--line)">{{ category.name }}</a>
          {% endfor %}
        </div>
      </nav>
    </header>
    <!-- Main -->
    <main id="content" class="max-w-7xl mx-auto px-4 py-10">
      {# Messages banner #}
      {% if messages %}
        <div class="mb-4">
          {% for message in messages %}
            <div class="rounded-xl border card px-4 py-3 text-sm {% if message.tags == 'success' %} border-green-200 {% elif message.tags == 'error' %} border-red-300 {% endif %}">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}
      {% block content %}{% endblock %}
    </main>
    <!-- Footer -->
    <footer class="mt-14">
      <div class="max-w-7xl mx-auto px-4">
        <div class="rounded-2xl border surface p-6">
          <div class="grid sm:grid-cols-2 md:grid-cols-3 gap-6">
            <div>
              <h3 class="font-semibold mb-2">ModernShop</h3>
              <p class="text-sm muted">Timeless basics, fast delivery, easy returns.</p>
            </div>
            <div>
              <h4 class="font-semibold mb-2">Menu</h4>
              <ul class="space-y-1 text-sm">
                <li>
                  <a href="{% url 'core:index' %}" class="hover:underline">Home</a>
                </li>
                <li>
                  <a href="{% url 'core:catalog_all' %}" class="hover:underline">Catalog</a>
                </li>
                <li>
                  <a href="/contact/" class="hover:underline">Contact</a>
                </li>
                <li>
                  {% if request.user.is_authenticated %}
                    <a href="{% url 'users:profile' %}" class="hover:underline">Account</a>
                  {% else %}
                    <a href="{% url 'users:login' %}" class="hover:underline">Sign in</a>
                  {% endif %}
                </li>
                <li>
                  <a href="#"
                     class="hover:underline"
                     hx-get="{% url 'cart:cart_modal' %}"
                     hx-target="#cart-modal"
                     hx-swap="outerHTML"
                     hx-select="#cart-modal"
                     hx-push-url="false"
                     onclick="openCartModal(); return false;">Cart</a>
                </li>
              </ul>
            </div>
            <div>
              <h4 class="font-semibold mb-2">Contact</h4>
              <p class="text-sm muted">support@modernshop.ge</p>
            </div>
          </div>
          <div class="mt-6 pt-4 text-sm muted flex items-center justify-between border-t"
               style="border-color: var(--line)">
            <span>&copy; {% now "Y" %} ModernShop. All rights reserved.</span>
            <span>Made with ❤️</span>
          </div>
        </div>
      </div>
    </footer>
    <!-- Mobile bottom bar -->
    <nav class="fixed md:hidden bottom-4 left-1/2 -translate-x-1/2 z-40">
      <div class="flex items-center gap-2 rounded-2xl border surface shadow-soft px-3 py-2">
        <a href="{% url 'core:index' %}"
           class="p-2 rounded-xl hover:shadow-soft transition"
           aria-label="Home">
          <svg xmlns="http://www.w3.org/2000/svg"
               class="w-6 h-6 opacity-80"
               viewBox="0 0 24 24"
               fill="currentColor">
            <path d="M12 3l9 8h-3v9H6v-9H3l9-8z" />
          </svg>
        </a>
        <a href="{% url 'core:catalog_all' %}"
           class="p-2 rounded-xl hover:shadow-soft transition"
           aria-label="Catalog">
          <svg xmlns="http://www.w3.org/2000/svg"
               class="w-6 h-6 opacity-80"
               viewBox="0 0 24 24"
               fill="currentColor">
            <path d="M4 6h16v2H4zm0 5h16v2H4zm0 5h10v2H4z" />
          </svg>
        </a>
        {% if request.user.is_authenticated %}
          <a href="{% url 'users:profile' %}"
             class="p-2 rounded-xl hover:shadow-soft transition"
             aria-label="Account">
            <svg xmlns="http://www.w3.org/2000/svg"
                 class="w-6 h-6 opacity-80"
                 viewBox="0 0 24 24"
                 fill="currentColor">
              <path d="M12 12a5 5 0 100-10 5 5 0 000 10zm0 2c-4.2 0-8 2.1-8 5v1h16v-1c0-2.9-3.8-5-8-5z" />
            </svg>
          </a>
        {% else %}
          <a href="{% url 'users:login' %}"
             class="p-2 rounded-xl hover:shadow-soft transition"
             aria-label="Sign in">
            <svg xmlns="http://www.w3.org/2000/svg"
                 class="w-6 h-6 opacity-80"
                 viewBox="0 0 24 24"
                 fill="currentColor">
              <path d="M12 12a5 5 0 100-10 5 5 0 000 10zm0 2c-4.2 0-8 2.1-8 5વ1h16v-1c0-2.9-3.8-5-8-5z" />
            </svg>
          </a>
        {% endif %}
        {% include "cart/includes/cart_button.html" with variant='mobile' %}
        <a href="{% url 'core:search' %}"
           class="p-2 rounded-xl hover:shadow-soft transition"
           aria-label="Search">
          <svg xmlns="http://www.w3.org/2000/svg"
               class="w-6 h-6 opacity-80"
               viewBox="0 0 24 24"
               fill="currentColor">
            <path d="M15.5 14h-.79l-.28-.27A6.5 6.5 0 1016 9.5c0 1.61-.59 3.09-1.57 4.23l.27.27h.79L20 18.5 18.5 20l-3-3zM5 9.5C5 7.01 7.01 5 9.5 5S14 7.01 14 9.5 11.99 14 9.5 14 5 11.99 5 9.5z" />
          </svg>
        </a>
        <button id="themeToggleMobile"
                class="p-2 rounded-xl hover:shadow-soft transition"
                aria-label="Toggle theme">
          <svg class="w-6 h-6 block dark:hidden"
               viewBox="0 0 24 24"
               fill="currentColor">
            <path d="M6.76 4.84l-1.8-1.79-1.41 1.41 1.79 1.8 1.42-1.42zM1 13h3v-2H1વ2zm10-9h2V1h-2v3zm7.04 2.46લ1.79-1.8-1.41-1.41-1.8 1.79 1.42 1.42zM20 13h3v-2h-3વ2zm-8 8h2v-3h-2વ3zM4.96 18.54લ-1.79 1.8 1.41 1.41 1.8-1.79-1.42-1.42zM17.24 19.16લ1.8 1.79 1.41-1.41-1.79-1.8-1.42 1.42zM12 6a6 6 0 100 12A6 6 0 0012 6z" />
          </svg>
          <svg class="w-6 h-6 hidden dark:block"
               viewBox="0 0 24 24"
               fill="currentColor">
            <path d="M12.22 2a10 10 0 109.78 11.01A8 8 0 0112.22 2z" />
          </svg>
        </button>
      </div>
    </nav>
    <!-- Cart Modal (overlay + sheet) -->
    <div id="cart-overlay" class="hidden fixed inset-0 z-50">
      <div class="absolute inset-0 bg-black/30" onclick="closeCartModal()"></div>
      <div id="cart-sheet"
           class="absolute inset-x-0 bottom-0 md:inset-y-0 md:right-0 md:left-auto md:w-[440px] rounded-t-2xl md:rounded-l-2xl surface shadow-2xl transform transition-transform duration-150 translate-y-full md:translate-y-0 md:translate-x-0 z-10">
        <div class="p-4 border-b" style="border-color: var(--line)">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold">Your Cart</h2>
            <button onclick="closeCartModal()"
                    class="px-2 py-1 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800"
                    aria-label="Close">✕</button>
          </div>
        </div>
        <div class="p-4">
          <div id="cart-modal">{% include "cart/cart_empty.html" %}</div>
        </div>
      </div>
    </div>
    <!-- Theme + Cart helpers + GLOBAL Filters helper + Account dropdown JS -->
    <script>
      function applyTheme(isDark){
        const root=document.documentElement;
        root.classList.toggle("dark",isDark);
        localStorage.setItem("theme",isDark?"dark":"light");
      }
      let isTogglingTheme=false;
      function toggleTheme(){
        if(isTogglingTheme) return;
        isTogglingTheme=true;
        const root=document.documentElement;
        root.classList.add("theme-smooth");
        const toDark=!root.classList.contains("dark");
        applyTheme(toDark);
        setTimeout(()=>{root.classList.remove("theme-smooth");isTogglingTheme=false;},320);
      }
      document.getElementById("themeToggle")?.addEventListener("click",toggleTheme);
      document.getElementById("themeToggleMobile")?.addEventListener("click",toggleTheme);

      function openCartModal(){
        const overlay=document.getElementById('cart-overlay');
        const sheet=document.getElementById('cart-sheet');
        overlay?.classList.remove('hidden');
        sheet?.classList.remove('translate-y-full');
      }
      function closeCartModal(){
        const overlay=document.getElementById('cart-overlay');
        const sheet=document.getElementById('cart-sheet');
        sheet?.classList.add('translate-y-full');
        if(overlay) setTimeout(()=>overlay.classList.add('hidden'),150);
      }

      // როცა cart_modal ჩაიტვირთება – გახსენი მოდალი
      document.addEventListener('htmx:afterSwap', (e) => {
        if (e.detail.target && e.detail.target.id === 'cart-modal') openCartModal();
      });

      // Cart badge refresh
      function refreshCartBadge(){
        fetch("{% url 'cart:cart_count' %}")
          .then(r=>r.json())
          .then(d=>{
            const ids = ['cart-badge','cart-badge-mobile'];
            ids.forEach(id => { const el=document.getElementById(id); if(el) el.textContent=d.total_items; });
            document.querySelectorAll('[data-cart-badge]').forEach(el => el.textContent=d.total_items);
          })
          .catch(()=>{});
      }
      document.addEventListener('DOMContentLoaded', refreshCartBadge);
      document.addEventListener('htmx:afterRequest', (e)=>{
        const url=e.detail?.xhr?.responseURL||'';
        if (/\/cart\/(add|update|remove|clear)\//.test(url)) refreshCartBadge();
      });

      document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') closeCartModal(); });

      /* ----------------------------
         GLOBAL Filters helpers
      ---------------------------- */
      function closeFilters(){
        const modal   = document.getElementById('modal');
        const sheet   = document.getElementById('filters-sheet');
        if (sheet) {
          sheet.classList.add('translate-x-full');
          setTimeout(() => {
            document.documentElement.classList.remove('overflow-hidden');
            if (modal) modal.innerHTML = '';
          }, 200);
        } else {
          document.documentElement.classList.remove('overflow-hidden');
          if (modal) modal.innerHTML = '';
        }
      }
      // ESC-ით დახურვა (ფილტრები)
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && document.getElementById('filters-sheet')) {
          closeFilters();
        }
      });

      /* ----------------------------
         Account dropdown logic
      ---------------------------- */
      (function(){
        const btn  = document.getElementById('accountMenuBtn');
        const menu = document.getElementById('accountMenu');
        if(!btn || !menu) return;

        let open = false;
        function show(){ menu.classList.remove('hidden'); btn.setAttribute('aria-expanded','true'); open = true; }
        function hide(){ menu.classList.add('hidden');   btn.setAttribute('aria-expanded','false'); open = false; }
        function toggle(){ open ? hide() : show(); }

        btn.addEventListener('click', (e)=>{ e.stopPropagation(); toggle(); });

        // click outside
        document.addEventListener('click', () => { if(open) hide(); });

        // ESC
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && open) hide(); });
      })();
    </script>
  </body>
</html>
