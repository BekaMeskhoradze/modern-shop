{% extends "core/base.html" %}
{% load static %}
{% block title %}{{ object.name }} ‚Äî Modern Shop{% endblock %}
{% block content %}
    <style>
    /* ·Éê·É†·É©·Éî·Éï·Éê·Éú·Éò·É° ·Éï·Éò·Éñ·É£·Éê·Éö·Éò (·Éñ·Éî·Éì·Éõ·Éî·É¢ JS-·Éò·É° ·Éí·Éê·É†·Éî·É®·Éî) */
    .size-selected{border-color:var(--accent)!important;background:rgba(245,158,11,.08)}
    .thumb-selected{border-color:var(--accent)!important; box-shadow:0 0 0 2px rgba(245,158,11,.35)}
    </style>
    <section class="grid lg:grid-cols-2 gap-8">
        <!-- Gallery -->
        <div>
            <div class="relative rounded-2xl overflow-hidden border card hover:shadow-soft transition"
                 style="border-color:var(--line)">
                <div class="relative pt-[100%] bg-[rgba(0,0,0,.04)] dark:bg-[rgba(255,255,255,.05)]">
                    {% comment %} ·Éõ·Éó·Éê·Éï·Éê·É†·Éò ·É°·É£·É†·Éê·Éó·Éò {% endcomment %}
                    <img id="mainImage"
                         src="{% if object.main_image %}{{ object.main_image.url }} {% elif gallery_images %}{{ gallery_images.0.image.url }} {% else %}{% static 'img/placeholder.svg' %}{% endif %}"
                         alt="{{ object.name }}"
                         class="absolute inset-0 w-full h-full object-cover"
                         width="900"
                         height="900"
                         loading="lazy"
                         decoding="async">
                </div>
            </div>
            {# ·Éó·É£·Éõ·Éë·Éú·Éî·Éò·Éö·Éî·Éë·Éò ‚Äì ·Éõ·Éó·Éê·Éï·Éê·É†·Éò ·É°·É£·É†·Éê·Éó·Éò ·Éû·Éò·É†·Éï·Éî·Éö·Éò·Éê #}
            <div id="thumbs" class="mt-4 grid grid-cols-4 gap-2">
                {% if object.main_image %}
                    <button type="button"
                            class="thumb rounded-xl overflow-hidden border card focus:outline-none hover:shadow-soft transition thumb-selected"
                            data-src="{{ object.main_image.url }}"
                            aria-pressed="true"
                            style="border-color:var(--line)">
                        <img src="{{ object.main_image.url }}"
                             alt=""
                             class="w-full h-24 object-cover"
                             loading="lazy">
                    </button>
                {% elif gallery_images %}
                    <button type="button"
                            class="thumb rounded-xl overflow-hidden border card focus:outline-none hover:shadow-soft transition thumb-selected"
                            data-src="{{ gallery_images.0.image.url }}"
                            aria-pressed="true"
                            style="border-color:var(--line)">
                        <img src="{{ gallery_images.0.image.url }}"
                             alt=""
                             class="w-full h-24 object-cover"
                             loading="lazy">
                    </button>
                {% else %}
                    <button type="button"
                            class="thumb rounded-xl overflow-hidden border card focus:outline-none transition thumb-selected"
                            data-src="{% static 'img/placeholder.svg' %}"
                            aria-pressed="true"
                            style="border-color:var(--line)">
                        <img src="{% static 'img/placeholder.svg' %}"
                             alt=""
                             class="w-full h-24 object-cover"
                             loading="lazy">
                    </button>
                {% endif %}
                {% for img in gallery_images %}
                    {% if not object.main_image or img.image.url != object.main_image.url %}
                        <button type="button"
                                class="thumb rounded-xl overflow-hidden border card focus:outline-none hover:shadow-soft transition"
                                data-src="{{ img.image.url }}"
                                aria-pressed="false"
                                style="border-color:var(--line)">
                            <img src="{{ img.image.url }}"
                                 alt=""
                                 class="w-full h-24 object-cover"
                                 loading="lazy">
                        </button>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
        <!-- Info + Add to cart -->
        <div>
            <h1 class="text-2xl font-semibold tracking-tight">{{ object.name|upper }}</h1>
            <p class="muted mt-1">{{ object.category.name }}</p>
            <div class="mt-4 flex items-baseline gap-2">
                <!-- ·Éõ·ÉÆ·Éù·Éö·Éù·Éì ·É§·Éê·É°·Éò, VAT-·Éò·É° ·Éí·Éê·É†·Éî·É®·Éî -->
                <span class="text-xl font-semibold">{{ object.price }}</span>
            </div>
            {% if object.color %}<p class="mt-2 text-sm muted">Color: {{ object.color }}</p>{% endif %}
            <div class="prose mt-6 max-w-none">{{ object.description|default:"" }}</div>
            {% if has_stock %}
                <!-- Sizes -->
                <div class="mt-6">
                    <p class="font-medium mb-2">Size</p>
                    <div class="flex flex-wrap gap-2" id="sizeGroup">
                        {% for ps in available_sizes %}
                            <label class="size-option px-3 py-2 rounded-xl border card cursor-pointer {% if forloop.first %}size-selected{% endif %}">
                                <input type="radio"
                                       name="size_id"
                                       value="{{ ps.id }}"
                                       class="sr-only"
                                       {% if forloop.first %}checked{% endif %}>
                                <span>{{ ps.size.name }}</span>
                            </label>
                        {% endfor %}
                    </div>
                    <div class="mt-1 text-sm muted">
                        Selected: <span id="selectedSize">{{ first_size.size.name }}</span>
                    </div>
                </div>
                <!-- Add to cart -->
                <div class="mt-4">
                    <form hx-post="{% url 'cart:add_to_cart' object.slug %}"
                          hx-target="#cart-modal"
                          hx-swap="outerHTML"
                          hx-select="#cart-modal"
                          hx-sync="#cart-modal:queue"
                          hx-disabled-elt="button, input, label"
                          hx-trigger="submit throttle:400ms"
                          hx-push-url="false"
                          class="space-y-4">
                        {% csrf_token %}
                        <input type="hidden"
                               name="size_id"
                               id="sizeHidden"
                               value="{{ first_size.id }}">
                        <div class="flex items-center gap-2">
                            <input type="number"
                                   min="1"
                                   value="1"
                                   name="quantity"
                                   class="w-20 px-3 py-2 rounded-xl border card">
                            <button type="submit" class="flex-1 brand-btn px-4 py-3 rounded-xl">Add to cart</button>
                        </div>
                    </form>
                </div>
            {% else %}
                <button class="mt-4 w-full px-4 py-3 rounded-xl border card opacity-60 cursor-not-allowed"
                        disabled>Out of stock</button>
            {% endif %}
            <ul class="mt-6 grid sm:grid-cols-2 gap-2 text-sm muted">
                <li>‚ö° Fast delivery</li>
                <li>‚Ü©Ô∏è Easy returns</li>
                <li>üí¨ Support</li>
                <li>üîí Secure checkout</li>
            </ul>
        </div>
    </section>
    <!-- Related -->
    <section class="mt-12">
        <h2 class="text-xl font-semibold tracking-tight mb-4">Related products</h2>
        {% if related_products %}
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                {% for p in related_products %}
                    <a href="{{ p.get_absolute_url }}"
                       class="group rounded-2xl border card p-3 hover:shadow-soft transition">
                        <div class="relative rounded-xl overflow-hidden border"
                             style="border-color:var(--line)">
                            <div class="relative pt-[100%] bg-[rgba(0,0,0,.04)] dark:bg-[rgba(255,255,255,.05)]">
                                <img src="{% if p.main_image %}{{ p.main_image.url }}{% else %}{% static 'img/placeholder.svg' %}{% endif %}"
                                     alt="{{ p.name }}"
                                     class="absolute inset-0 w-full h-full object-cover"
                                     loading="lazy">
                            </div>
                        </div>
                        <div class="pt-3 space-y-1">
                            <h3 class="font-medium truncate">{{ p.name }}</h3>
                            <div class="text-sm font-semibold">{{ p.price }}</div>
                        </div>
                    </a>
                {% endfor %}
            </div>
        {% else %}
            <p class="muted">No related products.</p>
        {% endif %}
    </section>
    <script>
    // ----- Sizes: ·Éï·Éò·Éñ·É£·Éê·Éö·Éò + hidden input + "Selected: X" -----
    (function(){
      const group  = document.getElementById('sizeGroup');
      const hidden = document.getElementById('sizeHidden');
      const out    = document.getElementById('selectedSize');
      if(!group) return;

      const setVisual = () => {
        group.querySelectorAll('label.size-option').forEach(l => l.classList.remove('size-selected'));
        const checked = group.querySelector('input[name="size_id"]:checked');
        if(checked){
          checked.closest('label')?.classList.add('size-selected');
          hidden.value = checked.value;
          out.textContent = checked.closest('label')?.innerText.trim();
        }
      };
      group.addEventListener('change', e => { if(e.target.name==='size_id'){ setVisual(); }});
      setVisual();
    })();

    // ----- Thumbnails: ·Éê·É†·É©·Éî·Éï·Éê + ·Éõ·Éó·Éê·Éï·Éê·É†·Éò ·É°·É£·É†·Éê·Éó·Éò·É° ·É®·Éî·É™·Éï·Éö·Éê -----
    (function () {
      const thumbsWrap = document.getElementById('thumbs');
      const mainImage  = document.getElementById('mainImage');
      if (!thumbsWrap || !mainImage) return;

      const buttons = Array.from(thumbsWrap.querySelectorAll('.thumb'));
      function markThumb(btn){
        buttons.forEach(b => { b.classList.remove('thumb-selected'); b.setAttribute('aria-pressed','false'); });
        btn.classList.add('thumb-selected');
        btn.setAttribute('aria-pressed','true');
      }

      thumbsWrap.addEventListener('click', (e) => {
        const btn = e.target.closest('.thumb');
        if (!btn) return;
        const src = btn.getAttribute('data-src');
        if (src) mainImage.src = src;
        markThumb(btn);
      });
    })();
    </script>
{% endblock %}
